#:kivy 2.0.0
#:import NoTransition kivy.uix.screenmanager.NoTransition
#:import SlideTransition kivy.uix.screenmanager.SlideTransition

# --- GLOBAL STYLES ---

<KegValueLabel@Label>:
    font_size: '18sp'
    bold: True
    halign: 'right'
    valign: 'middle'
    text_size: self.size
    size_hint_x: 0.2
    color: 0.6, 0.8, 1, 1

<NavButton@Button>:
    background_normal: ''
    background_color: 0.25, 0.25, 0.25, 1
    color: 1, 1, 1, 1
    font_size: '20sp'
    bold: True
    size_hint_y: 1

<FineTuneButton@Button>:
    background_normal: ''
    background_color: 0.25, 0.25, 0.25, 1
    font_size: '24sp'
    bold: True
    color: 0.6, 0.8, 1, 1  # Cyan text
    size_hint_x: None
    width: dp(45)
    canvas.before:
        Color:
            rgba: 0.4, 0.4, 0.4, 1
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 5)
            width: 1

<KegActionButton@Button>:
    background_normal: ''
    background_color: 0.3, 0.3, 0.3, 1
    font_size: '14sp'
    bold: True
    size_hint_x: None
    width: 100

<HeaderLabel@Label>:
    font_size: '24sp'
    bold: True
    color: 1, 0.75, 0, 1 # Amber
    size_hint_y: None
    height: 50
    canvas.before:
        Color:
            rgba: 0.15, 0.15, 0.15, 1
        Rectangle:
            pos: self.pos
            size: self.size

<EditLabel@Label>:
    font_size: '18sp'
    halign: 'left'
    valign: 'middle'
    text_size: self.size
    size_hint_x: 0.35

<TabButton@ToggleButton>:
    group: 'settings_tabs'
    font_size: '16sp'
    bold: True
    background_normal: ''
    background_color: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (1, 0.75, 0, 1)
    color: (1, 1, 1, 1) if self.state == 'normal' else (0, 0, 0, 1)
    allow_no_selection: False

# --- CUSTOM WIDGETS ---

<LevelGauge>:
    canvas:
        Color:
            rgba: 0.2, 0.2, 0.2, 1
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [10, 10, 10, 10]
        StencilPush
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [10, 10, 10, 10]
        StencilUse
        Color:
            rgba: root.liquid_color 
        Rectangle:
            pos: self.x, self.y
            size: self.width, (self.height * (self.percent / 100.0))
        StencilUnUse
        StencilPop
        Color:
            rgba: 0.0, 0.0, 0.0, 0.3 
        Line:
            points: [self.x, self.y + self.height*0.33, self.right, self.y + self.height*0.33]
            width: 2
        Line:
            points: [self.x, self.y + self.height*0.66, self.right, self.y + self.height*0.66]
            width: 2
        Color:
            rgba: 0.6, 0.6, 0.6, 1
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 10)
            width: 2

<TapWidget>:
    size_hint_x: None
    width: dp(150)
    orientation: 'vertical'
    padding: 10
    spacing: 5
    canvas.before:
        Color:
            rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0.12, 0.12, 0.12, 1)
        Rectangle:
            pos: self.pos
            size: self.size
    Label:
        text: root.tap_title
        font_size: '20sp'
        bold: True
        color: 1, 0.75, 0, 1
        size_hint_y: 0.12
    Label:
        text: root.beverage_name
        font_size: '16sp'
        color: 0.9, 0.9, 0.9, 1
        text_size: self.size
        halign: 'center'
        valign: 'middle'   # CHANGED: 'middle' centers 1 line, accommodates 2 lines
        size_hint_y: 0.18  # INCREASED: Was 0.12 (Adds room for 2nd line)
    Label:
        text: root.stats_text
        font_size: '13sp'
        color: 0.6, 0.6, 0.6, 1
        size_hint_y: 0.08
    LevelGauge:
        percent: root.percent_full
        liquid_color: root.liquid_color
        size_hint_y: 0.52  # DECREASED: Was 0.58 (Compensates for name label)
        size_hint_x: 0.5            
        pos_hint: {'center_x': 0.5} 
    Label:
        text: root.remaining_text
        font_size: '22sp'
        bold: True
        size_hint_y: 0.1
    Label:
        text: root.status_text
        font_size: '14sp'
        color: (0, 1, 0, 1) if root.status_text == "Pouring" else ((0.5, 0.5, 0.5, 1) if root.status_text != "OFFLINE" else (0.8, 0.2, 0.2, 1))
        size_hint_y: 0.1
        
<KegListItem>:
    size_hint_y: None
    height: 60
    orientation: 'horizontal'
    padding: 10
    spacing: 10
    canvas.before:
        Color:
            rgba: (0.2, 0.2, 0.2, 1) if self.index % 2 == 0 else (0.15, 0.15, 0.15, 1)
        Rectangle:
            pos: self.pos
            size: self.size
    Label:
        text: root.title
        font_size: '18sp'
        text_size: self.size
        halign: 'left'
        valign: 'middle'
        size_hint_x: 0.35
    Label:
        text: root.contents
        font_size: '16sp'
        text_size: self.size
        halign: 'left'
        valign: 'middle'
        size_hint_x: 0.35
    KegActionButton:
        text: 'Edit'
        on_release: app.open_keg_edit(root.keg_id)
    KegActionButton:
        text: 'Delete'
        background_color: 0.6, 0.1, 0.1, 1
        on_release: app.request_delete_keg(root.keg_id)
        
<BeverageListItem>:
    size_hint_y: None
    height: 60
    orientation: 'horizontal'
    padding: 10
    spacing: 10
    canvas.before:
        Color:
            rgba: (0.2, 0.2, 0.2, 1) if self.index % 2 == 0 else (0.15, 0.15, 0.15, 1)
        Rectangle:
            pos: self.pos
            size: self.size
    Label:
        text: root.name
        font_size: '18sp'
        text_size: self.size
        halign: 'left'
        valign: 'middle'
        size_hint_x: 0.7
    KegActionButton:
        text: 'Edit'
        on_release: app.open_beverage_edit(root.bev_id)
    KegActionButton:
        text: 'Delete'
        background_color: 0.6, 0.1, 0.1, 1
        on_release: app.request_delete_beverage(root.bev_id)

# --- POPUP WIDGETS ---
<ConfirmPopup>:
    size_hint: None, None
    size: dp(400), dp(250)
    title_size: '18sp'
    auto_dismiss: False
    
    # Custom Background to match Dark Theme
    canvas.before:
        Color:
            rgba: 0.1, 0.1, 0.1, 1
        Rectangle:
            pos: self.pos
            size: self.size
        Color:
            rgba: 0.8, 0.2, 0.2, 1 # Red Border for Warning
        Line:
            rectangle: self.x, self.y, self.width, self.height
            width: 2

    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 20
        
        Label:
            text: root.text
            font_size: '18sp'
            halign: 'center'
            valign: 'middle'
            text_size: self.size
            color: 0.9, 0.9, 0.9, 1
            
        BoxLayout:
            size_hint_y: None
            height: 50
            spacing: 20
            
            Button:
                text: "Cancel"
                font_size: '16sp'
                background_color: 0.4, 0.4, 0.4, 1
                on_release: root.dismiss()
                
            Button:
                text: "DELETE"
                bold: True
                font_size: '16sp'
                background_color: 0.8, 0.1, 0.1, 1
                on_release: root.confirm()

<SimulationPopup>:
    title: "Developer Simulation Dashboard"
    title_size: '18sp'
    title_align: 'center'
    
    # Force the popup to be a floating window, not full screen
    size_hint: None, None
    size: 600, 350
    
    # CRITICAL FIX: Make the area behind the popup semi-transparent
    overlay_color: 0, 0, 0, 0.5
    
    # Hide the default Kivy popup background texture
    background_color: 0, 0, 0, 0
    
    auto_dismiss: False
    
    # Draw our own background with an Amber border
    canvas.before:
        Color:
            rgba: 0.1, 0.1, 0.1, 1  # Dark Grey Background
        Rectangle:
            pos: self.pos
            size: self.size
        Color:
            rgba: 1, 0.75, 0, 1  # Amber Border
        Line:
            rectangle: self.x, self.y, self.width, self.height
            width: 2

    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 10
        
        # --- TEMPERATURE SIMULATION ---
        BoxLayout:
            size_hint_y: None
            height: 60
            orientation: 'horizontal'
            spacing: 10
            Label:
                text: "Sim Temp:"
                bold: True
                size_hint_x: 0.2
            Label:
                text: "{:.1f}".format(temp_slider.value)
                size_hint_x: 0.15
                font_size: '18sp'
                color: 0, 1, 0, 1
            Slider:
                id: temp_slider
                min: -5
                max: 80
                value: 4.0
                on_value: root.set_sim_temp(self.value)
                size_hint_x: 0.35
            Button:
                text: "Reset"
                size_hint_x: 0.3
                background_color: 0.3, 0.3, 0.3, 1
                on_release: root.reset_temp()

        # --- FLOW SIMULATION HEADER ---
        Label:
            text: "Simulate Flow"
            bold: True
            size_hint_y: None
            height: 30
            color: 0.7, 0.7, 0.7, 1
            
        # --- TAP LIST ---
        ScrollView:
            size_hint_y: 1
            canvas.before:
                Color:
                    rgba: 0.15, 0.15, 0.15, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            GridLayout:
                id: tap_grid
                cols: 1
                spacing: 2
                size_hint_y: None
                height: self.minimum_height
                padding: 5

        # --- CLOSE BUTTON ---
        Button:
            text: "Close Dashboard"
            size_hint_y: None
            height: 50
            bold: True
            background_color: 0.4, 0.1, 0.1, 1
            on_release: root.dismiss()

<SimTapRow@BoxLayout>:
    tap_index: 0
    tap_name: "Tap ?"
    size_hint_y: None
    height: 40
    spacing: 10
    Label:
        text: root.tap_name
        size_hint_x: 0.2
        bold: True
    Button:
        text: "Pour Pint (0.5L)"
        size_hint_x: 0.4
        background_color: 0.2, 0.4, 0.6, 1
        on_release: app.sim_pour_volume(root.tap_index, 0.5)
    ToggleButton:
        text: "Continuous Flow"
        size_hint_x: 0.4
        background_color: (0, 0.6, 0, 1) if self.state == 'down' else (0.3, 0.3, 0.3, 1)
        on_state: app.sim_toggle_flow(root.tap_index, self.state == 'down')

<KegSelectRow@Button>:
    background_normal: ''
    background_color: 0.2, 0.2, 0.2, 1
    size_hint_y: None
    height: 48
    text_size: self.size
    halign: 'left'
    valign: 'middle'
    padding: (20, 0)
    font_size: '18sp'
    bold: True
    canvas.after:
        Color:
            rgba: 0.4, 0.4, 0.4, 1
        Line:
            points: [self.x, self.y, self.right, self.y]
            width: 1

<KegSelectPopup>:
    size_hint: 0.8, 0.9
    auto_dismiss: False
    title: "Select Keg for Tap"
    title_size: '20sp'
    
    # Data Properties for Calibration
    tap_index: -1
    cal_keg_id: ""
    cal_keg_title: "Unknown"
    cal_start_vol: "--"
    cal_total_pulses: "--"
    cal_old_k: "--"
    cal_new_k: "--"
    cal_is_valid: False
    cal_confirmed: False

    ScreenManager:
        id: sm
        transition: NoTransition()
        
        # SCREEN 1: LIST SELECTION (Existing functionality)
        Screen:
            name: 'list'
            BoxLayout:
                orientation: 'vertical'
                padding: 10
                spacing: 10
                RecycleView:
                    id: rv_select
                    viewclass: 'KegSelectRow'
                    scroll_type: ['bars', 'content']
                    bar_width: 20
                    RecycleBoxLayout:
                        default_size: None, dp(48)
                        default_size_hint: 1, None
                        size_hint_y: None
                        height: self.minimum_height
                        orientation: 'vertical'
                Button:
                    text: "Cancel"
                    size_hint_y: None
                    height: 60
                    font_size: '18sp'
                    on_release: root.dismiss()

        # SCREEN 2: KEG KICKED CALIBRATION
        Screen:
            name: 'calibrate'
            BoxLayout:
                orientation: 'vertical'
                padding: 20
                spacing: 15
                
                # --- INFO SECTION ---
                Label:
                    text: "Calibration Data for " + root.cal_keg_title
                    font_size: '20sp'
                    bold: True
                    color: 1, 0.75, 0, 1
                    size_hint_y: None
                    height: 40

                GridLayout:
                    cols: 2
                    spacing: 10
                    size_hint_y: None
                    height: 160
                    
                    Label:
                        text: "Starting Volume:"
                        halign: 'right'
                        color: 0.7, 0.7, 0.7, 1
                    Label:
                        text: root.cal_start_vol
                        bold: True
                        halign: 'left'
                        
                    Label:
                        text: "Total Pulses:"
                        halign: 'right'
                        color: 0.7, 0.7, 0.7, 1
                    Label:
                        text: root.cal_total_pulses
                        bold: True
                        halign: 'left'

                    Label:
                        text: "Current K-Factor:"
                        halign: 'right'
                        color: 0.7, 0.7, 0.7, 1
                    Label:
                        text: root.cal_old_k
                        halign: 'left'

                    Label:
                        text: "CALCULATED NEW K-FACTOR:"
                        halign: 'right'
                        color: 0.5, 1, 0.5, 1
                        bold: True
                    Label:
                        text: root.cal_new_k
                        font_size: '22sp'
                        bold: True
                        color: 0.5, 1, 0.5, 1
                        halign: 'left'

                # --- CONFIRMATION ---
                BoxLayout:
                    size_hint_y: None
                    height: 60
                    spacing: 10
                    padding: 5 # Added padding for visual breathing room inside the color block
                    
                    # Light Green Background
                    canvas.before:
                        Color:
                            rgba: 0.2, 0.6, 0.2, 0.5 # Matches Save Button Green, 50% opacity
                        Rectangle:
                            pos: self.pos
                            size: self.size

                    CheckBox:
                        id: chk_confirm
                        size_hint_x: None
                        width: 50
                        on_active: root.cal_confirmed = self.active
                        color: 1, 1, 1, 1
                    
                    Label:
                        text: "This keg is empty and was fully dispensed from this tap."
                        text_size: self.size
                        valign: 'middle'
                        # Ensure text stands out against green
                        color: 1, 1, 1, 1 
                        bold: True

                # --- ACTIONS ---
                BoxLayout:
                    spacing: 20
                    size_hint_y: None
                    height: 70
                    
                    Button:
                        text: "Cancel"
                        background_color: 0.4, 0.4, 0.4, 1
                        on_release: root.ids.sm.current = 'list'
                        
                    Button:
                        text: "SAVE CALIBRATION & RESET"
                        bold: True
                        background_color: 0.2, 0.7, 0.2, 1
                        disabled: not (root.cal_is_valid and root.cal_confirmed)
                        on_release: app.commit_keg_kick_calibration(root)

# --- TABS FOR INVENTORY ---

<InventoryKegsTab@BoxLayout>:
    orientation: 'vertical'
    BoxLayout:
        size_hint_y: None
        height: 40
        padding: 10
        Label:
            text: "Keg Name"
            font_size: '18sp'
            bold: True
            size_hint_x: 0.35
            text_size: self.size
            halign: 'left'
        Label:
            text: "Contents"
            font_size: '18sp'
            bold: True
            size_hint_x: 0.35
            text_size: self.size
            halign: 'left'
        Label:
            text: "Actions"
            font_size: '18sp'
            bold: True
            size_hint_x: 0.3
    RecycleView:
        id: rv_kegs
        viewclass: 'KegListItem'
        scroll_type: ['bars', 'content']
        bar_width: 20
        RecycleBoxLayout:
            default_size: None, dp(60)
            default_size_hint: 1, None
            size_hint_y: None
            height: self.minimum_height
            orientation: 'vertical'

<InventoryBevsTab@BoxLayout>:
    orientation: 'vertical'
    BoxLayout:
        size_hint_y: None
        height: 40
        padding: 10
        Label:
            text: "Beverage Name"
            font_size: '18sp'
            bold: True
            size_hint_x: 0.7
            text_size: self.size
            halign: 'left'
        Label:
            text: "Actions"
            font_size: '18sp'
            bold: True
            size_hint_x: 0.3
    RecycleView:
        id: rv_bevs
        viewclass: 'BeverageListItem'
        scroll_type: ['bars', 'content']
        bar_width: 20
        RecycleBoxLayout:
            default_size: None, dp(60)
            default_size_hint: 1, None
            size_hint_y: None
            height: self.minimum_height
            orientation: 'vertical'

# --- TABS FOR SETTINGS ---

<SettingsCalibrationTab>:
    orientation: 'vertical'
    padding: 10
    spacing: 10
    
    # --- ROW 1: TABS (Dynamic & Centered) ---
    # We use AnchorLayout to center the row, matching the Dashboard look
    AnchorLayout:
        anchor_x: 'center'
        size_hint_y: None
        height: 24
        
        BoxLayout:
            id: tap_buttons_container
            orientation: 'horizontal'
            spacing: 10
            # These two lines are CRITICAL for centering:
            size_hint: None, 1
            width: self.minimum_width
            # Buttons are added here by Python init_ui()

    # --- ROW 2: INSTRUCTIONS ---
    Label:
        text: root.instruction_text
        font_size: '16sp'
        color: 0.8, 0.8, 0.8, 1
        size_hint_y: None
        height: 30
        text_size: self.size
        halign: 'center'
        valign: 'middle'

    # --- ROW 3: SLIDER CONTROLS ---
    BoxLayout:
        size_hint_y: None
        height: 60
        spacing: 10
        
        # Measured Vol Label
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: None
            width: 100
            Label:
                text: "Measured Vol:"
                font_size: '12sp'
                color: 0.7, 0.7, 0.7, 1
            Label:
                text: "{:.0f} {}".format(root.measured_volume, "mL" if root.is_metric else "oz") if root.is_metric else "{:.1f} {}".format(root.measured_volume, "oz")
                font_size: '20sp'
                bold: True

        # Minus Button
        Button:
            text: "-"
            font_size: '24sp'
            bold: True
            size_hint_x: None
            width: 50
            background_color: 0.3, 0.3, 0.3, 1
            on_release: root.adjust_volume(-10 if root.is_metric else -0.1)

        # Slider
        Slider:
            id: vol_slider
            min: 0
            max: 1000 # overridden in python
            value: root.measured_volume
            on_value: root.measured_volume = self.value

        # Plus Button
        Button:
            text: "+"
            font_size: '24sp'
            bold: True
            size_hint_x: None
            width: 50
            background_color: 0.3, 0.3, 0.3, 1
            on_release: root.adjust_volume(10 if root.is_metric else 0.1)

    # --- ROW 4: PULSES & RESULT ---
    BoxLayout:
        size_hint_y: None
        height: 100
        spacing: 20
        padding: (20, 10)

        # Pulses Box
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: None
            width: 180
            canvas.before:
                Color:
                    rgba: 0.1, 0.1, 0.1, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: 0.2, 0.6, 0.8, 1 # Blue Border
                Line:
                    rectangle: self.x, self.y, self.width, self.height
                    width: 2
            
            Label:
                text: str(int(root.current_pulses))
                font_size: '40sp'
                bold: True
                color: 0.2, 0.7, 1, 1 # Light Blue
            Label:
                text: "PULSES DETECTED"
                font_size: '10sp'
                color: 0.6, 0.6, 0.6, 1
                size_hint_y: None
                height: 20

        # K-Factor & Checkbox Area
        BoxLayout:
            orientation: 'vertical'
            spacing: 10
            
            # --- SPLIT K-FACTOR DISPLAY ROW ---
            BoxLayout:
                spacing: 10
                size_hint_y: None
                height: 50 # Adjusted height for better fit

                # BLOCK 1: NEW K-FACTOR (Green)
                BoxLayout:
                    padding: 5
                    canvas.before:
                        Color:
                            rgba: 0.15, 0.15, 0.15, 1
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    Label:
                        text: "New K:"
                        font_size: '16sp'
                        halign: 'left'
                        size_hint_x: 0.4
                    Label:
                        text: root.calculated_k
                        font_size: '20sp'
                        bold: True
                        color: 0, 1, 0, 1 # Green
                        halign: 'right'
                        size_hint_x: 0.6

                # BLOCK 2: CURRENT K-FACTOR (Amber/Yellow)
                BoxLayout:
                    padding: 5
                    canvas.before:
                        Color:
                            rgba: 0.15, 0.15, 0.15, 1
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    Label:
                        text: "Current:"
                        font_size: '16sp'
                        color: 0.7, 0.7, 0.7, 1
                        halign: 'left'
                        size_hint_x: 0.4
                    Label:
                        text: root.current_k_display
                        font_size: '20sp'
                        bold: True
                        color: 1, 0.75, 0, 1 # Amber
                        halign: 'right'
                        size_hint_x: 0.6
            
            # Deduct Checkbox
            BoxLayout:
                spacing: 10
                CheckBox:
                    active: root.deduct_inventory
                    on_active: root.deduct_inventory = self.active
                    size_hint_x: None
                    width: 40
                Label:
                    text: "Deduct volume from Inventory?"
                    font_size: '14sp'
                    text_size: self.size
                    valign: 'middle'

<SettingsConfigTab>:
    orientation: 'vertical'
    padding: 20
    spacing: 15
    
    # 1. UNITS
    BoxLayout:
        size_hint_y: None
        height: 60
        spacing: 10
        Label:
            text: "Display Units:"
            font_size: '22sp'
            bold: True
            halign: 'left'
            valign: 'middle'
            text_size: self.size
            size_hint_x: 0.3
        BoxLayout:
            size_hint_x: 0.7
            spacing: 20
            ToggleButton:
                id: btn_imperial
                text: "US Imperial\n(Gal / lb)"
                group: 'units'
                allow_no_selection: False
                font_size: '18sp'
                bold: True
                background_normal: ''
                background_color: (0.2, 0.6, 0.2, 1) if self.state == 'down' else (0.2, 0.2, 0.2, 1)
            ToggleButton:
                id: btn_metric
                text: "Metric\n(L / kg)"
                group: 'units'
                allow_no_selection: False
                font_size: '18sp'
                bold: True
                background_normal: ''
                background_color: (0.2, 0.6, 0.2, 1) if self.state == 'down' else (0.2, 0.2, 0.2, 1)

    # 2. TAPS
    BoxLayout:
        size_hint_y: None
        height: 60
        Label:
            text: "Active Taps:"
            font_size: '22sp'
            bold: True
            halign: 'left'
            valign: 'middle'
            text_size: self.size
            size_hint_x: 0.3
        Spinner:
            id: spin_taps
            text: "4"
            values: ["1", "2", "3", "4", "5"]
            size_hint_x: 0.35
            font_size: '20sp'
            background_color: 0.25, 0.25, 0.25, 1
        
        # Spacer to maintain alignment
        Label:
            size_hint_x: 0.35

    # 3. MIGRATION (New Section)
    BoxLayout:
        size_hint_y: None
        height: 60
        Label:
            text: "Data Migration:"
            font_size: '22sp'
            bold: True
            halign: 'left'
            valign: 'middle'
            text_size: self.size
            size_hint_x: 0.3
        Button:
            text: "IMPORT FROM\nKEGLEVEL MONITOR"
            font_size: '14sp'
            bold: True
            background_color: 0.2, 0.4, 0.8, 1
            size_hint_x: 0.35
            on_release: root.request_monitor_import()
        Label:
            size_hint_x: 0.35

    # Spacer
    Label:
        size_hint_y: 1

<SettingsUpdatesTab>:
    orientation: 'vertical'
    padding: 20
    spacing: 10
    
    # LOG CONSOLE
    TextInput:
        text: root.log_text
        readonly: True
        background_color: 0, 0, 0, 1
        foreground_color: 0, 1, 0, 1 # Matrix Green
        font_size: '14sp'
        font_name: "RobotoMono-Regular"
        size_hint_y: 1
    
    # (Buttons removed from here, moved to Footer)

<SettingsAboutTab@ScrollView>:
    do_scroll_x: False
    do_scroll_y: True
    
    BoxLayout:
        orientation: 'vertical'
        size_hint_y: None
        height: self.minimum_height
        padding: 20
        spacing: 10
        
        # --- TOP SECTION: LEFT TEXT / RIGHT IMAGE ---
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: self.minimum_height
            spacing: 10
            
            # Left Column: Brands AND Support Text
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                pos_hint: {'top': 1}
                spacing: 20 # Clear separation between paragraphs
                
                # --- SECTION 1: BRANDS ---
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: 5
                    
                    Label:
                        text: "KegLevel Brands"
                        text_size: self.width, None
                        size_hint_y: None
                        height: self.texture_size[1]
                        halign: 'left'
                        font_size: '20sp'
                        bold: True
                        color: 1, 0.75, 0, 1

                    Label:
                        text: "KettleBrain(c), FermVault(c), KegLevel(c), BatchFlow(c), and TempMonitor(c) names, texts, UI/UX and program code are copyrighted. This material and all components of this program are protected by copyright law. Unauthorized use, duplication, or distribution is strictly prohibited."
                        text_size: self.width, None
                        size_hint_y: None
                        height: self.texture_size[1]
                        halign: 'left'
                        font_size: '16sp'
                        color: 0.9, 0.9, 0.9, 1

                # --- SECTION 2: SUPPORT (Moved Here to fix gap) ---
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: 5

                    Label:
                        text: "Support This App"
                        text_size: self.width, None
                        size_hint_y: None
                        height: self.texture_size[1]
                        halign: 'left'
                        font_size: '20sp'
                        bold: True
                        color: 1, 0.75, 0, 1

                    Label:
                        text: "This App took hundreds of hours to develop, test, and optimize. Please consider supporting this App with a donation so continuous improvements can be made. If you wish to receive customer support via email, please make a reasonable donation. Customer support requests without a donation may not be considered."
                        text_size: self.width, None
                        size_hint_y: None
                        height: self.texture_size[1]
                        halign: 'left'
                        font_size: '16sp'
                        color: 0.9, 0.9, 0.9, 1
            
            # Right Column: Image with 30px Padding
            AnchorLayout:
                anchor_x: 'right'
                anchor_y: 'top'
                size_hint_x: None
                width: 200
                size_hint_y: None
                height: 200 
                padding: [30, 30, 30, 30]
                
                Image:
                    source: 'assets/support.gif'
                    size_hint: None, None
                    size: 140, 140
                    allow_stretch: True
                    keep_ratio: True

        # --- BOTTOM SECTION: ACKNOWLEDGEMENTS ---
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            spacing: 5

            Label:
                text: "Acknowledgements"
                text_size: self.width, None
                size_hint_y: None
                height: self.texture_size[1]
                halign: 'left'
                font_size: '20sp'
                bold: True
                color: 1, 0.75, 0, 1

            Label:
                text: "Icons created by Pixel Perfect - Flaticon\nhttps://www.flaticon.com/free-icons/update"
                text_size: self.width, None
                size_hint_y: None
                height: self.texture_size[1]
                halign: 'left'
                font_size: '16sp'
                color: 0.9, 0.9, 0.9, 1

# --- SCREENS ---

<SimControlWidget@BoxLayout>:
    orientation: 'vertical'
    size_hint_x: None
    width: dp(150)  # Matches <TapWidget> width
    spacing: 5
    padding: 2
    tap_index: 0
    
    Button:
        text: "PINT (0.5L)"
        background_color: 0.2, 0.6, 0.8, 1
        font_size: '14sp'
        bold: True
        on_release: app.sim_pour_volume(root.tap_index, 0.5)

    ToggleButton:
        text: "CONTINUOUS"
        background_color: (0, 0.8, 0, 1) if self.state == 'down' else (0.3, 0.3, 0.3, 1)
        font_size: '14sp'
        bold: True
        on_state: app.sim_toggle_flow(root.tap_index, self.state == 'down')

<LoadingScreen@Screen>:
    name: 'loading'
    BoxLayout:
        orientation: 'vertical'
        canvas.before:
            Color:
                rgba: 0.1, 0.1, 0.1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        
        AnchorLayout:
            anchor_x: 'center'
            anchor_y: 'center'
            BoxLayout:
                orientation: 'vertical'
                size_hint: None, None
                size: self.minimum_size
                spacing: 20
                
                Label:
                    text: "KegLevel Lite"
                    font_size: '40sp'
                    bold: True
                    color: 1, 0.75, 0, 1 # Amber
                    size_hint: None, None
                    size: self.texture_size
                    pos_hint: {'center_x': 0.5}
                
                Label:
                    text: "Initializing System..."
                    font_size: '20sp'
                    color: 0.7, 0.7, 0.7, 1
                    size_hint: None, None
                    size: self.texture_size
                    pos_hint: {'center_x': 0.5}
                    
<DashboardScreen>:
    kegerator_temp: ""
    BoxLayout:
        orientation: 'vertical'
        
        # --- HEADER (Unchanged) ---
        FloatLayout:
            size_hint_y: None
            height: 50
            canvas.before:
                Color:
                    rgba: 0.15, 0.15, 0.15, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            Label:
                text: "KegLevel Lite"
                font_size: '24sp'
                bold: True
                color: 1, 0.75, 0, 1
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            
            # Temp Label + Hidden Trigger
            Label:
                text: root.kegerator_temp
                font_size: '24sp'
                bold: True
                color: 0.2, 0.7, 1, 1
                size_hint: None, None
                size: self.texture_size
                pos_hint: {'right': 0.98, 'center_y': 0.5}

            Button:
                text: ""
                background_color: 0, 0, 0, 0
                opacity: 0
                size_hint: None, None
                size: 150, 50
                pos_hint: {'right': 1.0, 'center_y': 0.5}
                on_release: root.on_temp_area_click()

        # --- MAIN TAP DISPLAY ---
        AnchorLayout:
            anchor_x: 'center'
            anchor_y: 'center'
            BoxLayout:
                id: tap_container
                orientation: 'horizontal'
                spacing: 10
                size_hint: None, 1
                width: self.minimum_width
        
        # --- DYNAMIC FOOTER (Nav vs Sim) ---
        ScreenManager:
            id: footer_manager
            # CHANGED: Fixed height to match Settings/Inventory
            size_hint_y: None
            height: 60  
            transition: SlideTransition(direction='up')

            # MODE 1: Normal Navigation
            Screen:
                name: 'nav_mode'
                BoxLayout:
                    orientation: 'horizontal'
                    padding: 5 # Increased from 2 to match others
                    spacing: 10 # Increased from 2 to match others
                    NavButton:
                        text: "INVENTORY"
                        font_size: '16sp' # Standardized
                        on_release: app.root.current = 'inventory'
                    NavButton:
                        text: "SETTINGS"
                        font_size: '16sp' # Standardized
                        on_release: app.root.current = 'settings'

            # MODE 2: Simulation Controls
            Screen:
                name: 'sim_mode'
                BoxLayout:
                    orientation: 'vertical'
                    canvas.before:
                        Color:
                            rgba: 0.1, 0.1, 0.1, 1
                        Rectangle:
                            pos: self.pos
                            size: self.size
                        Color:
                            rgba: 1, 0.5, 0, 1 # Orange border top
                        Line:
                            points: [self.x, self.top, self.right, self.top]
                            width: 2

                    # Just the controls, centered
                    AnchorLayout:
                        anchor_x: 'center'
                        anchor_y: 'center'
                        BoxLayout:
                            id: sim_container
                            orientation: 'horizontal'
                            spacing: 10
                            size_hint: None, 1
                            width: self.minimum_width

<InventoryScreen>:
    BoxLayout:
        orientation: 'vertical'
        HeaderLabel:
            text: "Inventory Management"
        BoxLayout:
            size_hint_y: None
            height: 50
            padding: 5
            spacing: 5
            
            # USED CUSTOM CLASS (Consistent with Settings Screen)
            TabButton:
                text: "KEGS"
                group: 'inv_tabs'
                state: 'down'
                font_size: '18sp'
                on_release: root.show_kegs()

            TabButton:
                text: "BEVERAGES"
                group: 'inv_tabs'
                font_size: '18sp'
                on_release: root.show_bevs()
        ScreenManager:
            id: tab_manager
            transition: NoTransition()
            Screen:
                name: 'tab_kegs'
                InventoryKegsTab:
                    id: kegs_tab
            Screen:
                name: 'tab_bevs'
                InventoryBevsTab:
                    id: bevs_tab
        BoxLayout:
            size_hint_y: None
            height: 60
            padding: 5
            spacing: 10
            
            # --- UPDATED BUTTON ---
            Button:
                text: "BACK TO DASHBOARD"
                font_size: '16sp'
                bold: True
                background_normal: ''              # Flat style
                background_color: 0.4, 0.4, 0.4, 1 # Dark Grey
                size_hint_x: 0.3
                on_release: app.root.current = 'dashboard'
            
            Label:
                size_hint_x: 0.4
            
            Button:
                text: "+ ADD NEW"
                font_size: '16sp'
                bold: True
                size_hint_x: 0.3
                background_color: 0, 0.5, 0, 1
                on_release: root.add_new_item()

<KegEditScreen>:
    BoxLayout:
        orientation: 'vertical'
        HeaderLabel:
            text: root.screen_title
        BoxLayout:
            orientation: 'vertical'
            padding: 20
            spacing: 15
            BoxLayout:
                size_hint_y: None
                height: 50
                EditLabel:
                    text: "Contents:"
                Spinner:
                    id: bev_spinner
                    text: root.beverage_name
                    values: root.beverage_list
                    size_hint_x: 0.6
                    font_size: '18sp'
                    on_text: root.beverage_name = self.text
                    
# --- ROW 1: MAX CAPACITY ---
            BoxLayout:
                size_hint_y: None
                height: 50
                EditLabel:
                    text: "Max Capacity:"
                    size_hint_x: 0.25
                
                FineTuneButton:
                    text: "-"
                    on_release: sli_max.value = max(sli_max.min, sli_max.value - sli_max.step)

                Slider:
                    id: sli_max
                    min: root.vol_min   # <-- Dynamic
                    max: root.vol_max   # <-- Dynamic
                    step: root.vol_step # <-- Dynamic
                    value: root.max_volume_liters
                    size_hint_x: 0.6
                    on_value: root.set_max_volume_from_slider(self.value)

                FineTuneButton:
                    text: "+"
                    on_release: sli_max.value = min(sli_max.max, sli_max.value + sli_max.step)

                KegValueLabel:
                    text: root.ui_max_vol_text
                    size_hint_x: 0.15

            # --- ROW 2: TARE WEIGHT ---
            BoxLayout:
                size_hint_y: None
                height: 50
                EditLabel:
                    text: "Empty (Tare):"
                    size_hint_x: 0.25

                FineTuneButton:
                    text: "-"
                    on_release: sli_tare.value = max(sli_tare.min, sli_tare.value - sli_tare.step)

                Slider:
                    id: sli_tare
                    min: root.tare_min   # <-- Dynamic
                    max: root.tare_max   # <-- Dynamic
                    step: root.tare_step # <-- Dynamic
                    value: root.tare_weight_kg
                    size_hint_x: 0.6
                    on_value: root.set_tare_from_slider(self.value)

                FineTuneButton:
                    text: "+"
                    on_release: sli_tare.value = min(sli_tare.max, sli_tare.value + sli_tare.step)

                KegValueLabel:
                    text: root.ui_tare_text
                    size_hint_x: 0.15

            # --- ROW 3: TOTAL WEIGHT ---
            BoxLayout:
                size_hint_y: None
                height: 50
                EditLabel:
                    text: "Total Weight:"
                    size_hint_x: 0.25

                FineTuneButton:
                    text: "-"
                    on_release: sli_total.value = max(sli_total.min, sli_total.value - sli_total.step)

                Slider:
                    id: sli_total
                    min: root.total_min   # <-- Dynamic
                    max: root.total_max   # <-- Dynamic
                    step: root.total_step # <-- Dynamic
                    value: root.total_weight_kg
                    size_hint_x: 0.6
                    on_value: root.set_total_from_slider(self.value)

                FineTuneButton:
                    text: "+"
                    on_release: sli_total.value = min(sli_total.max, sli_total.value + sli_total.step)

                KegValueLabel:
                    text: root.ui_total_text
                    size_hint_x: 0.15
                    
            BoxLayout:
                size_hint_y: None
                height: 60
                padding: (0, 10, 0, 0)
                Label:
                    # UPDATED: Added Markup for SG explanation
                    text: "Liquid Volume:\n[size=14sp][color=#888888](calc @ 1.014 SG)[/color][/size]"
                    markup: True 
                    font_size: '20sp'
                    bold: True
                    halign: 'right'
                    valign: 'middle'
                    text_size: self.size
                    size_hint_x: 0.6
                Label:
                    text: root.ui_calculated_text
                    font_size: '28sp'
                    bold: True
                    color: 0, 1, 0, 1
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size
                    size_hint_x: 0.4
                    padding: (20, 0)
        BoxLayout:
            size_hint_y: None
            height: 70
            padding: 10
            spacing: 20
            Button:
                text: "Cancel"
                font_size: '18sp'
                background_color: 0.6, 0.2, 0.2, 1
                on_release: app.root.current = 'inventory'
            Button:
                text: "Save Keg"
                font_size: '18sp'
                bold: True
                background_color: 0.2, 0.6, 0.2, 1
                on_release: root.save_keg_edit()

<BeverageEditScreen>:
    BoxLayout:
        orientation: 'vertical'
        # HeaderLabel removed to match Edit Keg screen
        
        BoxLayout:
            orientation: 'vertical'
            # Padding and spacing kept from previous fix
            padding: 15
            spacing: 10
            
            # --- ROW 1: NAME ---
            BoxLayout:
                size_hint_y: None
                height: 50
                EditLabel:
                    text: "Beverage Name:"
                TextInput:
                    text: root.bev_name
                    multiline: False
                    font_size: '20sp'
                    size_hint_x: 0.65
                    on_text: root.bev_name = self.text

            # --- ROW 2: BJCP STYLE ---
            BoxLayout:
                size_hint_y: None
                height: 50
                EditLabel:
                    text: "BJCP Style:"
                Spinner:
                    text: root.bev_bjcp if root.bev_bjcp else "Select Style"
                    values: root.bjcp_list
                    size_hint_x: 0.65
                    font_size: '18sp'
                    background_normal: ''
                    background_color: 0.25, 0.25, 0.25, 1
                    option_cls: 'SpinnerOption'
                    on_text: root.bev_bjcp = self.text

            # --- ROW 3: ABV SLIDER ---
            BoxLayout:
                size_hint_y: None
                height: 50
                EditLabel:
                    text: "ABV %:"
                    size_hint_x: 0.25

                FineTuneButton:
                    text: "-"
                    on_release: sli_abv.value = max(sli_abv.min, sli_abv.value - sli_abv.step)

                Slider:
                    id: sli_abv
                    min: 0.0
                    max: 14.0
                    step: 0.1
                    value: root.bev_abv
                    size_hint_x: 0.5
                    on_value: root.bev_abv = self.value

                FineTuneButton:
                    text: "+"
                    on_release: sli_abv.value = min(sli_abv.max, sli_abv.value + sli_abv.step)

                KegValueLabel:
                    text: "{:.1f} %".format(root.bev_abv)
                    size_hint_x: 0.15

            # --- ROW 4: IBU SLIDER ---
            BoxLayout:
                size_hint_y: None
                height: 50
                EditLabel:
                    text: "IBU:"
                    size_hint_x: 0.25

                FineTuneButton:
                    text: "-"
                    on_release: sli_ibu.value = max(sli_ibu.min, sli_ibu.value - sli_ibu.step)

                Slider:
                    id: sli_ibu
                    min: 0
                    max: 100
                    step: 1
                    value: root.bev_ibu
                    size_hint_x: 0.5
                    on_value: root.bev_ibu = int(self.value)

                FineTuneButton:
                    text: "+"
                    on_release: sli_ibu.value = min(sli_ibu.max, sli_ibu.value + sli_ibu.step)

                KegValueLabel:
                    text: "{:.0f}".format(root.bev_ibu)
                    size_hint_x: 0.15

            # --- ROW 5: COLOR (SRM) ---
            BoxLayout:
                size_hint_y: None
                height: 60
                EditLabel:
                    text: "Color (SRM):"
                    size_hint_x: 0.3
                Slider:
                    min: 0
                    max: 40
                    step: 1
                    value: root.bev_srm
                    size_hint_x: 0.5
                    on_value: root.bev_srm = int(self.value)
                Label:
                    text: str(root.bev_srm)
                    font_size: '20sp'
                    bold: True
                    size_hint_x: 0.1
                Widget:
                    size_hint_x: 0.1
                    canvas:
                        Color:
                            rgba: root.preview_color
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [5, 5, 5, 5]
                        Color:
                            rgba: 1, 1, 1, 0.3
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, 5)
                            width: 1
            Label: 
                size_hint_y: 1 # Spacer

        BoxLayout:
            size_hint_y: None
            height: 70
            padding: 10
            spacing: 20
            Button:
                text: "Cancel"
                font_size: '18sp'
                background_color: 0.6, 0.2, 0.2, 1
                on_release: app.root.current = 'inventory'
            Button:
                text: "Save Beverage"
                font_size: '18sp'
                bold: True
                background_color: 0.2, 0.6, 0.2, 1
                on_release: app.save_beverage_edit()

<SettingsScreen>:
    BoxLayout:
        orientation: 'vertical'
        
        # --- HEADER WITH SECRET BUTTON ---
        FloatLayout:
            size_hint_y: None
            height: 50
            canvas.before:
                Color:
                    rgba: 0.15, 0.15, 0.15, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            # The Title
            Label:
                text: "Settings Management"
                font_size: '24sp'
                bold: True
                color: 1, 0.75, 0, 1
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}

            # The Invisible "Secret Knock" Button (Top Right)
            Button:
                text: ""
                background_color: 0, 0, 0, 0 # Transparent
                size_hint: None, 1           # Full height of header
                width: 120                   # Wide enough to hit easily
                pos_hint: {'right': 1, 'y': 0}
                on_release: root.handle_secret_click()

        # --- TAB HEADER ---
        BoxLayout:
            size_hint_y: None
            height: 50
            padding: 5
            spacing: 2
            
            TabButton:
                id: btn_sys
                text: "SYSTEM"
                group: 'settings_tabs'
                allow_no_selection: False
                on_release: root.set_active_tab('conf')
            TabButton:
                id: btn_upd
                text: "UPDATES"
                group: 'settings_tabs'
                allow_no_selection: False
                on_release: root.set_active_tab('upd')
            TabButton:
                id: btn_about
                text: "ABOUT"
                group: 'settings_tabs'
                allow_no_selection: False
                on_release: root.set_active_tab('about')
            TabButton:
                id: btn_cal
                text: "CALIBRATION"
                group: 'settings_tabs'
                allow_no_selection: False
                on_release: root.set_active_tab('cal')

        # --- CONTENT AREA ---
        ScreenManager:
            id: settings_manager
            transition: NoTransition()
            
            Screen:
                name: 'tab_conf'
                SettingsConfigTab:
                    id: tab_conf_content
            Screen:
                name: 'tab_upd'
                SettingsUpdatesTab:
                    id: tab_upd_content
            Screen:
                name: 'tab_about'
                SettingsAboutTab:
            Screen:
                name: 'tab_cal'
                SettingsCalibrationTab:
                    id: tab_cal_content

        # --- DYNAMIC FOOTER AREA ---
        ScreenManager:
            id: footer_manager
            size_hint_y: None
            height: 60
            transition: NoTransition()

            # 1. SYSTEM FOOTER
            Screen:
                name: 'footer_conf'
                BoxLayout:
                    padding: 5
                    spacing: 10
                    Button:
                        text: "CANCEL / EXIT"
                        font_size: '16sp'
                        bold: True
                        background_normal: '' # MATCHING FLAT STYLE
                        background_color: 0.4, 0.4, 0.4, 1
                        on_release: app.root.current = 'dashboard'
                    Label:
                        text: "" 
                    Label:
                        text: "" 
                    Button:
                        text: "SAVE SETTINGS"
                        font_size: '16sp'
                        bold: True
                        background_color: 0.2, 0.6, 0.2, 1
                        on_release: root.ids.tab_conf_content.save_config()

            # 2. UPDATES FOOTER
            Screen:
                name: 'footer_upd'
                BoxLayout:
                    padding: 5
                    spacing: 10
                    Button:
                        text: "CANCEL / EXIT"
                        font_size: '16sp'
                        bold: True
                        background_normal: '' # MATCHING FLAT STYLE
                        background_color: 0.4, 0.4, 0.4, 1
                        on_release: app.root.current = 'dashboard'
                    Button:
                        text: "CHECK"
                        font_size: '16sp'
                        bold: True
                        background_color: 0.2, 0.4, 0.8, 1
                        disabled: root.ids.tab_upd_content.is_working
                        on_release: root.ids.tab_upd_content.check_updates()
                    Button:
                        text: "INSTALL"
                        font_size: '16sp'
                        bold: True
                        background_color: 0.2, 0.6, 0.2, 1
                        disabled: not root.ids.tab_upd_content.install_enabled or root.ids.tab_upd_content.is_working
                        on_release: root.ids.tab_upd_content.install_updates()
                    Button:
                        text: "RESTART"
                        font_size: '16sp'
                        bold: True
                        background_color: 1, 0.6, 0, 1
                        disabled: root.ids.tab_upd_content.is_working
                        on_release: root.ids.tab_upd_content.restart_app()

            # 3. ABOUT FOOTER
            Screen:
                name: 'footer_about'
                BoxLayout:
                    padding: 5
                    spacing: 10
                    Button:
                        text: "CANCEL / EXIT"
                        font_size: '16sp'
                        bold: True
                        background_normal: '' # MATCHING FLAT STYLE
                        background_color: 0.4, 0.4, 0.4, 1
                        on_release: app.root.current = 'dashboard'
                    Label: 
                    Label: 
                    Label: 

            # 4. CALIBRATION FOOTER
            Screen:
                name: 'footer_cal'
                BoxLayout:
                    padding: 5
                    spacing: 10
                    Button:
                        text: "CANCEL / EXIT"
                        font_size: '16sp'
                        bold: True
                        background_normal: '' # MATCHING FLAT STYLE
                        background_color: 0.4, 0.4, 0.4, 1
                        on_release: 
                            root.ids.tab_cal_content.reset_calibration()
                            root.set_calibration_mode(False) 
                            app.root.current = 'dashboard'
                    
                    Button:
                        text: "SET TO DEFAULT"
                        font_size: '16sp'
                        bold: True
                        background_color: 0.2, 0.4, 0.8, 1
                        disabled: root.ids.tab_cal_content.locked_tap_index == -1
                        on_release: root.ids.tab_cal_content.set_to_default_k_factor()

                    Button:
                        text: "RESET PULSES"
                        font_size: '16sp'
                        bold: True
                        background_color: 0.2, 0.4, 0.8, 1
                        on_release: root.ids.tab_cal_content.reset_calibration()

                    Button:
                        text: "SAVE CALIBRATION"
                        font_size: '16sp'
                        bold: True
                        background_color: 0.2, 0.6, 0.2, 1
                        disabled: root.ids.tab_cal_content.locked_tap_index == -1
                        on_release: root.ids.tab_cal_content.save_calibration()

            # 5. MIMIC POUR FOOTER (Hidden until triggered)
            Screen:
                name: 'footer_cal_mimic'
                AnchorLayout:
                    anchor_x: 'center'
                    BoxLayout:
                        id: mimic_container
                        orientation: 'horizontal'
                        spacing: 10
                        size_hint: None, 1
                        width: self.minimum_width
